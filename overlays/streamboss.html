<!DOCTYPE html>
<html>
<head>
  <title>streamboss</title>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ‘‘</text></svg>">
</head>
<body>
  <div id="app">
    <div class="streamloop-container">
      <div class="current-streamboss">
        <div class="avatar">
          <img class="avatar-img" v-bind:src="bossImg || 'https://static-cdn.jtvnw.net/jtv_user_pictures/15982081-1895-4737-ae19-ed69dca83f5f-profile_image-300x300.jpg'" alt="">
        </div>
        <div class="content">
          <p class="title">CROSSOS KING</p>
          <h1 class="username">{{streamboss.user || 'mrpierrecroce'}}</h1>
          <div class="progress-container">
            <div class="progress">
              <span class="progress-bar" :style="{width: ((goal-current)/goal) * 100 + '%'}"></span>
            </div>
            <div class="progress-infos">
              <div class="progress-alert" v-if="showAlert">
                <span class="message">KWIIISKA ATTAQUE !</span> <span class="pts">-300</span> <img class="lightning" src="/assets/lightning.svg" alt="">
              </div>
              <span class="hp">{{goal - current}} PV</span>
            </div>
          </div>
        </div>
      </div>
      <div class="top-3">
        <p class="top-title">TOP CHALLENGERS</p>
        <ul class="top-list">
          <li class="top-item" :class="[`item-${index+1}`]" v-for="(viewer, index) in viewers.slice(0, 3)" v-if="viewer.sessionPoints > 0">
            {{ viewer.user }} <span class="pts">{{ viewer.sessionPoints }} dÃ©gÃ¢ts</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</body>

<script>
let queue = [];
var timer;
var audio = new Audio('/assets/sfx/master-sword.mp3');
audio.volume = 1;

var socket = io('', {query: "user=hackerloop"});
var app = new Vue({
  el: '#app',
  data: {
    streamboss: {},
    viewers: [],
    isPlaying: false,
    goal: 0,
    current: 0,
    userImg: '',
    bossImg: '',
    showAlert: false
  },
  created () {

    socket.on('WIDGETS_DATA', (obj) => {
      var data = obj.find(elem => {
        return elem.name == "streamboss"
      })
      console.log(data);
      this.streamboss = data.boss;
      this.goal = data.goal;
      this.current = data.current;

      axios.get('https://decapi.me/twitch/avatar/'+this.streamboss.user)
      .then((response) => {
        this.bossImg = response.data;
      })
    });

    socket.on('VIEWERS_LIST', (obj) => {
      console.log('VIEWERS_LIST', obj);
      this.viewers = obj;
    });

    socket.on('VIEWER_EVENT', (obj) => {
      console.log(obj);
      queue.push(obj);
      this.playEvent();
    });

    socket.on('RELOAD_OVERLAY', () => {
      console.log("RELOAD");
      location.reload();
    });
  },

  computed: {
    lastEvent() {
      return this.events.slice(-1)[0]
    }
  },

  methods: {
    playEvent() {
      if (this.isPlaying) {
        console.log('Alert is still playing');
        return;
      }
      if (!queue.length) {
        console.log('queue is empty');
        return;
      }
      const event = queue.shift();

      // axios.get('https://decapi.me/twitch/avatar/'+event.user)
      // .then((response) => {
      //   console.log(response.data);
      //   this.userImg = response.data;
      //   this.playAlert();
      // })
      this.playAlert();
    },

    playAlert(event) {

      //audio.play();
      this.isPlaying = true;

      setTimeout(() => {
        console.log('Alert is done playing');
        this.isPlaying = false;
        this.userImg = "";
        setTimeout(() => {
          this.playEvent();
        }, 1000);
      }, 4000);
    }
  }
})
</script>

<style lang="scss" scoped>
  @import url('https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,400;0,900;1,400;1,700&display=swap');

  body {
    background-color: #ccc;
  }

  html, body {
    font-family: 'Barlow', sans-serif;
    margin: 0;
    padding: 0;
  }

  *, *:before, *:after {
    box-sizing: border-box;
  }

  p, ul, span {
    margin: 0;
  }

  /* CUSTOM CSS */
  #app {
    display: flex;
    flex-direction: column;
  }

  .streamloop-container {
    max-width: 485px;
    width: 100%;
    margin: 0 auto;
    color: white;
    margin-top: 10px;
  }

  .current-streamboss {
    display: flex;
    flex-direction: row;
  }
    .avatar {
      position: relative;
      width: 155px;
      height: 188px;
      background-image: url('/assets/king.svg');
      background-repeat: no-repeat;
      margin-right: 10px;
      margin-bottom: 5px;
    }
      .avatar-img {
        position:  absolute;
        top: 50px;
        left: 17px;
        width: 114px;
        height: 114px;
        display: block;
        /* background-color: rgba(255, 255, 255, 1); */
        border-radius: 3px;
        overflow: hidden;
      }

    .current-streamboss .content {
      padding-top: 54px;
      flex: 1;
    }
      .current-streamboss .title {
        font-style: italic;
        font-weight: normal;
        text-shadow: 0px 4px 4px rgba(0, 0, 0, 0.5);
        margin: 0;
      }
      .current-streamboss .username {
        font-style: normal;
        font-weight: 900;
        font-size: 36px;
        line-height: 1em;
        text-shadow: 5px 4px 1px rgba(0, 0, 0, 0.45);
        margin: 0;
        margin-bottom: 10px;
      }

    .progress {
      position: relative;
      border: 1px solid #FFFFFF;
      border-radius: 4px;
      height: 38px;
      width: 100%;
      display: block;
    }
      .progress-bar {
        position: absolute;
        top: 0;
        left: 0;
        background: #CA003D;
        border-radius: 3px;
        display: block;
        height: 100%;
        width: 100%;
      }

    .progress-container {
      position: relative;
    }

    .progress-infos {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      text-align: right;
    }
      .progress-infos .hp {
        margin-right: 10px;
        margin-top: 9px;
        display: block;
        position: relative;
        font-style: normal;
        font-weight: bold;
        font-size: 14px;
        line-height: 17px;
        text-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
        white-space: nowrap;
      }
      .progress-alert {
        position: absolute;
        z-index: 1;
        top: 0;
        left: 0;
        margin-top: -6px;
        font-style: italic;
        font-weight: bold;
        font-size: 14px;
        display: flex;
        align-items: center;
        padding-left: 12px;
      }
        .progress-alert .message {
          text-overflow: ellipsis;
        }
        .progress-alert .pts {
          font-weight: 800;
          font-size: 18px;
          color: #FF9900;
          display: inline-block;
          margin-left: 10px;
        }
        .progress-alert .lightning {
          margin-left: 2px;
        }

  .top-3 {
    padding-left: 5px;
  }
    .top-title {
      font-style: italic;
      font-weight: bold;
      font-size: 16px;
      text-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
      margin-bottom: 8px;
      padding-left: 5px;
    }
    .top-list {
      list-style: none;
      padding: 0;
    }
      .top-item {
        font-style: normal;
        font-weight: 900;
        font-size: 18px;
        text-shadow: 3px 2px 1px rgba(0, 0, 0, 0.45);
      }
      .top-item .pts {
        font-style: italic;
        font-weight: normal;
        font-size: 14px;
        text-shadow: 0px 4px 4px rgba(0, 0, 0, 0.25);
        margin-left: 5px;
      }
        .top-item::before {
          content: '';
          display: inline-block;
          background-image: url('/assets/lightning-gold.svg');
          background-repeat: no-repeat;
          width: 23px;
          height: 25px;
          vertical-align: middle;
        }
        .item-1::before {
          background-image: url('/assets/lightning-gold.svg');
        }
        .item-2::before {
          background-image: url('/assets/lightning-silver.svg');
        }
        .item-3::before {
          background-image: url('/assets/lightning-bronze.svg');
        }
</style>

</html>