<!DOCTYPE html>
<html>
<head>
  <title>My first Overlay</title>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
  <div id="app">
    <div class="container" v-if="dossierImg">
      <img class="chest" v-bind:src="chestImg">
      <img class="dossierImg" v-bind:src="dossierImg" />
      <video id="myVideo" class="dossierVideo" v-bind:src="dossierVideo" autoplay></video>
    </div>
    <!-- <div class="container">
      <img class="chest" src="/assets/treasurechest.gif" alt="">
      <img class="dossierImg" src="http://res.cloudinary.com/dcr72h6g0/image/upload/v1593649321/test/giphy_oqseh7.gif" />
      <video id="myVideo" class="dossierVideo" src="https://res.cloudinary.com/hzim7siiy/video/upload/v1594890742/TwitchPhotosDossier/coverr-sample076-2660_zobaej.mp4" autoplay></video>
    </div> -->
  </div>
</body>

<script>
let goal, fieldData;

let botPoints = 0;
let sessionData;

var timer;

let audio = new Audio('/assets/sfx/master-sword.mp3');
audio.volume = 1;

var socket = io('', {query: "user=hackerloop"});
var app = new Vue({
  el: '#app',
  data: {
    goal: 0,
    count: 0,
    duration: 0,
    alertMessage: "",
    alertImg: "",
    events: {},
    dossierImg: "",
    dossierVideo: "",
    chestImg: ""
  },
  created () {
    /*
    socket.on('EVENT', (obj) => {
      console.log(obj);
      if (obj.listener == "OnSEDonation") {
        this.alertMessage = obj.event.user + " donate " + obj.event.amount.toLocaleString(undefined,{style: 'currency',currency:"EUR"});

        axios.get('https://decapi.me/twitch/avatar/'+obj.event.user)
        .then((response) => {
          console.log(response.data);
          if(response.data.startsWith('http')) {
            this.alertImg = response.data;
            // setTimeout(() => {
            //   this.alertImg = "";
            //   this.alertMessage = "";
            // }, 10000);
          }
          else {
            console.log(response);
            this.alertImg = 'https://static-cdn.jtvnw.net/jtv-static/404_preview-300x300.png';
          }
        })
      }
    });
    */

    socket.on('WIDGETS_DATA', (obj) => {
      var data = obj.find(elem => {
        return elem.name == "dossier"
      })
      console.log(data);
      this.goal = data.goal;
      this.count = data.count;
      this.duration = data.duration;
    });

    socket.on('EVENT_LIST', (obj) => {
      var data = obj.filter(elem => {
        return elem.listener == "OnSEDonation"
      })
      console.log(data);
      this.events = data;
    });

    socket.on('EVENT_DOSSIER', (obj) => {
      if (obj.resource_type == "image") {
        this.dossierImg = obj.url;
        this.chestImg = '/assets/treasurechest.gif';
        audio.play();
        clearTimeout(timer);
        var timer = setTimeout(() => {
          this.dossierImg = "";
          this.chestImg = "";
          this.dossierVideo = "";
        }, this.duration);
      }
      if (obj.resource_type == "video") {
        clearTimeout(timer);
        this.dossierVideo = obj.url;
        this.chestImg = '/assets/treasurechest.gif';
        audio.play();
      }
    });

    document.getElementById('myVideo').addEventListener('ended',myHandler,false);
    function myHandler(e) {
      this.dossierImg = "";
      this.dossierVideo = "";
      this.chestImg = "";
    }
  },

  computed: {
    lastEvent() {
      return this.events.slice(-1)[0]
    }
  },

  methods: {

  }
})
</script>

<style lang="scss" scoped>
  * {
    font-family: 'arial', sans-serif;
  }

  html, body {
    margin: 0;
    padding: 0;
  }

  .alertImg {
    width: 100px;
    height: auto;
  }

  .container {
    display: flex;
    align-items: center;
    width: 100%;
    min-height: 100vh;
    justify-content: center;
    width: 100%;
    height: 100vh;
    display: flex;
  }

  @keyframes imgZoom {
    0% {
      width: 0%;
      height: 0%;
      opacity: 0;
    }
    50% {
      width: 0%;
      height: 0%;
      opacity: 1;
    }
    100% {
      width: 90%;
      height: 90%;
      opacity: 1;
    }
  }

  @keyframes chestIn {
    0% {
      opacity: 0;
    }
    100% {
      opacity: 1;
    }
  }

  .dossierImg {
    display: inline-block;
    width: 600px;
    height: auto;
    width: 90%;
    height: 90%;
    object-fit: contain;
    /* transition: all 1s ease-out; */
    z-index: 1;
    animation: 2s ease-out 0s 1 imgZoom;
  }

  .dossierVideo {
    position: absolute;
    display: inline-block;
    width: 600px;
    height: auto;
    width: 90%;
    height: 90%;
    object-fit: contain;
    /* transition: all 1s ease-out; */
    z-index: 1;
    animation: 2s ease-out 0s 1 imgZoom;
  }

  .chest {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translateX(-50%) translateY(-50%);
    animation: 1s ease-out 0s 1 chestIn;
  }
</style>

</html>